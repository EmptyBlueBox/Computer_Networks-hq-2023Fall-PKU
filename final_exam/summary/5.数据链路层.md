# 5.数据链路层

## 基本概念

数据链路层的作用是在**<u>物理相连</u>**的两个结点间进行数据传输

2层数据包：帧，封装了3层数据包，第四层是segment段，或者叫datagram

### 数据链路层特点：差异性

不同链路上采用不同协议：
• 如：第一个链路为以太网链路，中间链路为帧中继，最后一跳为802.11无线链路不同的链路层协议提供不同的服务
• 如：可靠 vs 不可靠

### 数据链路层实现的位置

每一台主机与网络内部设备都需要实现链路层

链路层的实现通常包括硬件、固件（可以被修改的物理模块）、软件部分

硬件与固件：链路层主要功能在“网络适配器”（又称网络接口卡 Network Interface Card，NIC)，NIC包括数据链路层+物理层，NIC通过数据总线（buses）接入系统，与链路层软件部分交互

软件：给网络层提供接口、中断处理等

### 数据链路层提供的服务

成帧 (Framing) ：将比特流切分成帧
•将比特流划分成“帧”的主要目的是为了检测和纠正物理层在比特传输中可能出现的错误，数据链路层功能需借助“帧”的各个域来实现

差错控制 (Error Control)
•处理传输中出现的差错，如位错误、丢失等

流量控制（Flow Control）
•确保发送方的发送速率，不大于接收方的处理速率，避免接收缓冲区溢出

**<u>无确认 无连接</u>** 服务（Unacknowledged connectionless ）
• 接收方不对收到的帧进行确认
• 适用场景：误码率低的可靠信道；实时通信；很可靠所以不用确认，但是也是因为不确认，所以理论上是不可靠的
•网络实例：**<u>以太网</u>**

**<u>有确认 无连接</u>**服务（Acknowledged connectionless ）
• 每一帧都得到单独的确认
• 适用场景：不可靠的信道（无线信道）；但是因为有确认，所以理论上是可靠的
• 网络实例：**<u>802.11</u>**

有确认 有连接服务（Acknowledged connection-oriented）
• 适用场景：长延迟的不可靠信道，海底光缆

### 分组（packet）与帧（frame）的关系

<img src="./5.数据链路层.assets/CleanShot 2024-01-02 at 23.47.27@2x.png" alt="CleanShot 2024-01-02 at 23.47.27@2x" style="zoom:30%;" />

头标 （Header）：
•头标通常包含地址信息，它指明了帧的源地址和目的地址。这使得接收方能够识别发送方，并决定是否接受帧。
•另外，头标还可能包含其他控制信息，如同步信息（帮助接收方确定帧的开始），类型字段（指示帧中数据的类型或协议），以及流控制和错误检测信息。

尾标（Trailer）：
•尾标主要用于确保帧的完整性。它通常包含一个或多个错误检测字段，如循环冗余检查（CRC）字段，用于检测帧在传输过程中是否遭受损坏。
•在某些协议中，尾标还可能包含帧结束标志，以帮助接收方确定帧的结尾。

关键问题：如何标识一个帧的开始？
•接收方必须能从物理层接收的比特流中明确区分出一帧的开始和结束，这个问题被称为帧同步或帧定界
•关键：选择何种定界符？定界符出现在数据部分如何处理？

成帧（framing）的方式
• 字节计数法（Byte count）
• 带字节填充的定界符法（Flag bytes with byte stuffing）
• 带比特填充的定界符法（Flag bits with bit stuffing）
• 物理层编码违例（Physical layer coding violations）

## 成帧：字节计数法

无差错传输才可以

<img src="./5.数据链路层.assets/CleanShot 2024-01-02 at 23.48.27@2x.png" alt="CleanShot 2024-01-02 at 23.48.27@2x" style="zoom:30%;" />



问题：如果某个计数字节出错会发生什么情况？破坏了帧的边界，导致一连串帧的错误

## 成帧：带字节填充的定界符

带字节填充的定界符法
•定界符（FLAG）：一个特殊的字节，比如 01111110，即 0x7E，用于区分前后两个不同的帧

<img src="./5.数据链路层.assets/CleanShot 2024-01-02 at 23.50.56@2x.png" alt="CleanShot 2024-01-02 at 23.50.56@2x" style="zoom:30%;" />

**<u>注意FLAG不算帧的一部分，因为FLAG不是一个帧拥有的，是两个帧之间的</u>**



问题：如果有效载荷部分包含与“定界符”相同的字节会有什么问题？使用转义字节解决这个问题

依次扫描识别FLAG，但是**<u>遇见转义字节就删除它然后不扫描下一个字节</u>**，这样之后如果再遇见FLAG就说明帧结束了

<img src="./5.数据链路层.assets/CleanShot 2024-01-02 at 23.56.45@2x.png" alt="CleanShot 2024-01-02 at 23.56.45@2x" style="zoom:30%;" />

带字节填充的定界符法：接收方的处理

• 逐个检查收到的每一个字节

• 收到ESC，则后一字节无条件成为有效载荷，不予检查

• 收到FLAG则为帧的边界



问题：效率不高

## 成帧：带比特填充的定界符

带比特填充的定界符法
•定界符：两个0比特之间，连续6个1比特，即01111110，0x7E

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 00.06.50@2x.png" alt="CleanShot 2024-01-03 at 00.06.50@2x" style="zoom:50%;" />



问题：如果有效载荷部分包含与“定界符”相同的位组合如何解决？

若在有效载荷中出现连续5个1比特，则直接插入1个0比特，打断连续的6个1，这样只要遇到了连续6个1就说明完成了1帧

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 00.09.58@2x.png" alt="CleanShot 2024-01-03 at 00.09.58@2x" style="zoom:50%;" />

若出现连续5个1比特
- 若下一比特为0，则为有效载荷，直接丢弃0比特
- 若下一比特为1，则连同后一比特的0，构成定界符，一帧结束

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 00.10.22@2x.png" alt="CleanShot 2024-01-03 at 00.10.22@2x" style="zoom:50%;" />

## 成帧：物理层编码违例

> 只要求4B/5B

核心思想：选择的定界符不会在数据部分出现

4B/5B编码方案
• 4比特数据映射成5比特编码，剩余的一半码字（16个码字）未使用，可以用做帧定界符
• 例如：00110组合不包含在4B/5B编码中，可做帧定界符

## ★差错控制：基本概念

链路层存在的一个问题：**<u>信道的噪声</u>**导致数据传输问题
• 差错（incorrect）：数据发生错误
• 丟失（lost）：接收方未收到
• 乱序（out of order）：先发后到，后发先到，对性能影响最大
• 重复（repeatedly delivery）：一次发送，多次接收

解决方案：差错检测与**<u>纠正</u>**、**<u>确认重传</u>**
• 确认：接收方校验数据（差错校验），并给发送方应答，防止差错
• 定时器：发送方启动定时器，防止丢失
• 顺序号：接收方检查序号，防止乱序递交、重复递交

### 差错检测和纠正

如何解决信道传输差错问题
• 通常采用增加冗余信息（或称校验信息）的策略
•简单示例：每个比特传三份，如果每比特的三份中有一位出错，可以纠正，蓝牙1/3 FEC采用这种方法

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 00.23.27@2x.png" alt="CleanShot 2024-01-03 at 00.23.27@2x" style="zoom:30%;" />

携带2/3的冗余信息！冗余信息量大！

### 保证一定差错检测和纠错能力的前提下，如何减少冗余信息量？

考虑的问题
• 信道的特征和传输需求
• 冗余信息的计算方法、携带的冗余信息量
• 计算的复杂度等

两种主要策略
•检错码（error-detecting code）误码率低的路线使用，光纤，因为**<u>误码率低所以重传开销小，所以检测错误即可</u>**
•纠错码（error-correcting code）误码率高的路线，无线

选择策略具体策略取决于信道特征，如：
• 误码率较高的无线链路
• 误码率较低的光纤链路

### 检错码 (error-detecting code)
• 只能使接收方推断是否发生错误，但不能推断哪位发生错误，接收方可以请求发送方重传数据
•主要用在高可靠、误码率较低的信道上，例如光纤链路
•偶尔发生的差错，可以通过重传解决差错问题

### 纠错码 （error-correcting code） 

**<u>虽然纠错码开销比检错码开销大，但是开销最大的是重传</u>**

• 接收方能够判断接收到的数据是否有错，并能纠正错误（定位出错的位置）
•主要用于错误发生比较频繁的信道上，如无线链路
•也经常用于物理层，以及更高层（例如，实时流媒体应用和内容分发）
•使用纠错码的技术通常称为前向纠错（FEC,Forward Error Correction）

前向：不需要重传就能纠正的意思

## ★差错控制：奇偶校验 (Parity Check)

1位奇偶校验：增加1位校验位，可以检查奇数位错误



问题：考虑二维奇偶校验，是否可以进行纠错？

二维奇偶校验：可以检测并纠错单个比特错误

## ★差错控制：校验和 (Checksum)

TCP/IP体系中主要采用的错误检测方法（具体见UDP部分讲义）

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 00.38.28@2x.png" alt="CleanShot 2024-01-03 at 00.38.28@2x" style="zoom:30%;" />

## ★差错控制：循环冗余校验 (CRC, Cyclic Redundancy Check)

CRC校验码计算方法
•设原始数据D为m位二进制串
•如果要产生r位CRC校验码，事先选定一个r+1位二进制串G（称为生成多项式，收发双方提前商定），G的最高位为1
•将原始数据D乘以2（相当于在D后面添加 r 个0），产生m+r位二进制串
•用G对D*2^r做模2除，得到余数R（r位，不足r位前面用0补齐）即为CRC校验码

接收端校验：收到<D，R>
•**<u>将<D，R>除以G（模2除），若余数为0，则通过校验</u>**

模2除：加法不进位，減法不借位，因为是模2除，不用取反就是0

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 00.47.31@2x.png" alt="CleanShot 2024-01-03 at 00.47.31@2x" style="zoom:50%;" />

CRC校验能检测出少于r+1位的错误

### CRC例子

• D = 1010001101，r= 5
• G = 110101（或写成多项式G = X5+ X4+ X2+1）
• R = 01110
• 实际传输数据：101000110101110

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 00.50.21@2x.png" alt="CleanShot 2024-01-03 at 00.50.21@2x" style="zoom:30%;" />

### 如何选择生成多项式G？
四个国际标准生成多项式
• CRC-12 = ×12+×11+×3+×2+×+1
• CRC-16 = ×16+×15+×2+1
• CRC-CCITT = ×16+×12+×5+1
• CRC-32 = x32+x26+x23+x22+x16+x12+x|1+x10+x8+x7+x5+x4+x2+x+1
例如，以太网、无线局域网使用CRC-32生成多项式

## ★差错控制：纠正单比特错误所需校验位下界

码字（code word）：一个包含m个数据位（信息位）和 r 个校验位的n位单元，描述为（n,m）码， n=m+r

码率（code rate）：码字中不含冗余部分所占的比例，可以用m/n表示（有用的比例）

海明距离 （Hamming distance）：两个码字之间不同对应比特的数目，0000000000 与0000011111的海明距离为5

如果两个码字的海明距离为d，则需要d个单比特错就可以把一个码字转换成另一个码字

为了检查出d个错（比特错），可以使用海明距离为d+1 的编码，因为任意两个合法的码字之间距离是d+1，如果出错d位也不会变成另一个合法的码字

为了纠正d个错，可以使用海明距离为 2d+1 的编码，因为任意两个合法的码字（包含校验位）之间距离至少是2d+1，这样就算出错d位也能通过找距离最近的码字来纠错

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 01.11.39@2x.png" alt="CleanShot 2024-01-03 at 01.11.39@2x" style="zoom:50%;" />

例如：
•一个只有4个有效码字的编码方案：0000000000, 0000011111, 1111100000, 1111111111
•海明距离为5，可以检测4位错，纠正2位错
•如果已知只有1位或2位错误，接收方接收0000000111，则可知原码字为：0000011111
•如果发生3位错误，例如0000000000变成0000000111，接收方无法纠正错误，但可以检测出错误

### 纠正单比特错误的最低要求
• 目的：m个信息位，r 个校验位，纠正单比特错
• n个比特一共可以有 $2^n$ 个码字，包含有效码字与无效码字
• 每个m位有效信息，除了本身的n位有效码字，与该有效码字距离为1的n个码字必须无效
• 否则，当单比特错误发生时，无法判断是否出错
• 同时，任何两个有效码字，它们距离为1的无效码字没有重叠
• 否则，无法判断错误的码字离哪个有效码字更近
• 因此，每个m位有效信息，实际上消耗至少 n+1 个码字，即：$\mathrm{(n+1)~2^m\leq2^n}$
• 利用n=m+r，得到 $(\mathrm{m}+\mathrm{r}+1)\leq2^\mathrm{r}$
• 在给定m的情况下，利用该式可以得出r的下界，并且该下界可以达到，如：海明码

## ★差错控制：海明码

海明距离（Hamming distance）：两个码字之间不同对应比特的数目

目标：以奇偶校验为基础，如何找到出错位置，提供1位纠错能力

理解海明码编码过程，以（15， 11）海明码为例
• 15位=11个数字位+4个校验位
•校验位：2的幂次方位（记为p1，p2, p4, p8）
•每个校验位对数据位的子集做校验，缩小定位错误的范围

例如：11比特的数据01011001101
• 11比特数据按顺序放入数据位

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 01.34.46@2x.png" alt="CleanShot 2024-01-03 at 01.34.46@2x" style="zoom:50%;" />

海明码缺省为偶校验（也可以使用奇校验）

偶校验：每个校验位对应的子集中总共有偶数个1

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 01.36.24@2x.png" alt="CleanShot 2024-01-03 at 01.36.24@2x" style="zoom:50%;" />

### 海明码例子

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 01.37.36@2x.png" alt="CleanShot 2024-01-03 at 01.37.36@2x" style="zoom:50%;" />

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 01.38.49@2x.png" alt="CleanShot 2024-01-03 at 01.38.49@2x" style="zoom:30%;" />

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 01.38.59@2x.png" alt="CleanShot 2024-01-03 at 01.38.59@2x" style="zoom:30%;" />

错误位导致P1、P2、P4校验失败，所以错误位为第1+2+4=7位

## ★差错控制：RS (Reed-Solomon Code) 编码不考



## ★多路访问控制：概念

### 为什么需要访问控制

信道：信号的通道
•比如：双绞线、铜缆、光纤、卫星、空气等

点到点信道：信道直接连接两个端点
• 比如：家中计算机通过modem连接到电信公司端局

多点访问信道：多用户共享一根信道
•右图是以太网的典型拓扑，早期连接核心是集线器，现在几乎都是交换机
• 早期使用集线器的以太网是总线式的，信道是共享的
•其他例子：WiFi

共享一根信道（别称：广播信道、多路访问信道、随机访问信道）



问题：可能两个（或更多）站点同时请求占用信道，产生冲突 （collisions）

解决办法：介质的多路访问控制
在多路访问信道上确定下一个使用者（信道分配）
本质上是分布式算法

挑战：结点间协同，本身也需要使用信道，但是没有专门用于分布式访问控制的信道

### 理想的多路访问控制
已知：广播信道速率 R bps

目标：
•  性能：当只有一个结点需要传输时，能够以速率R进行发送
• 公平：当M个结点需要传输时，每个结点发送速率R/M
• 去中心化
•不需要结点协调传输
• **<u>不需要全局时钟</u>**或者其他全局信息
• 简单、易实现

## ★多路访问控制：信道划分

### TDMA

TDMA: time division multiple access

划分出等长时间片（长度为报文传输时间），时间片依次分给各个站点，但是未使用的时间片处于空闲，利用率不高

例子：6-站点共享信道，站点1, 3, 4有数据包要发送，时间片2,5,6空闲

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 01.45.30@2x.png" alt="CleanShot 2024-01-03 at 01.45.30@2x" style="zoom:50%;" />

### FDMA

FDMA: frequency division multiple access

将信道分为多个频段,每个站点分配得到1个固定的频段，每个频段带宽相同，未使用的频段处于空闲

例子：6-站点共享信道，站点13,4有数据包要发送，频段2,5,6空闲

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 01.46.07@2x.png" alt="CleanShot 2024-01-03 at 01.46.07@2x" style="zoom:30%;" />

### CDMA

CDMA: Code Division Multiple Access

为每个站点分配一种编码
即使冲突发生，接收方也能进行解码
主要用于无线通信（后续无线部分会讲到）

### 静态分配的性能分析

静态分配方法：TDM、FDM



先考虑只有一个信道的情况：

静态分配的排队论分析（M/M/1排队系统模型）
•M（顾客到达时间间隔分布）
• 帧到达时间间隔服从指数分布
•平均到达率（输入率）：$\lambda$ 帧秒
• M（服务时间分布）
•帧长度服从指数分布，平均长度 $\frac1\mu$ 位
•信道容量为C位秒，则信道服务率为 $\mu C$ 帧/秒
• 1（并列服务台个数）

根据排队理论，可证明：单信道平均延迟时间T（顾客在服务系统中的逗留时间）为：
$$
\begin{aligned}T=\frac1{(\mu C-\lambda)}\end{aligned}
$$


然后将这个信道平均分，对应TDMA, FDMA：
$$
T_{FDMA}=\frac1{\mu(C/N)-(\lambda/N)}=\frac N{\mu C-\lambda}=NT
$$


信道划分越细，延迟越高，因为空闲变多

### 静态分配的特点

问题
• 资源分配不合理，不满足用户对资源占用的不同

需求
•有**<u>资源浪费</u>**，效率低
•**<u>延迟时间增大N倍</u>**

适用情况
• 适于**<u>用户数量少</u>**且用户数目固定的情况
• 适于通信量大且**<u>流量稳定</u>**的情况
•不适用于突发性业务的情况

设计动态分配的方法
• 目的1：更好地满足需求
• 目的2：提高信道利用率

## ★多路访问控制：随机访问

> 不考：基于泊松分布的 ALOHA 效率分析、CDMA/CD 效率分析、自适应树协议

当任意站点有数据要发送时
• 以信道带宽R全速发送
•不需要事先协调

当2个或更多站点同时发送时，产生冲突

随机访问的多路信道需要注意：
•冲突检测
•从冲突中恢复（如：等待一段时间后重发）

典型例子：
• 纯ALOHA
• 时隙ALOHA (slotted ALOHA)
• CSMA
• CSMA/CD
• CSMA/CA

### 纯ALOHA

原理：想发就发！
• 每个站点收到上层数据包，立即向信道发送
• 没有任何同步或信道检测

特点
• 冲突：某个时刻有两个或以上的帧
• 随时可能冲突
• 冲突的帧被完全破坏
• 破坏了的帧要重传

#### 纯ALOHA的效率

效率的指标：N个站点时，信道传输成功的概率

假设：
• 传输时间为1单位时间
• N个站点，每个站点在单位时间内的传输概率为p，也就是任意一个长度为1的时间区间，某个站点开始传输的概率是p

P（某个站点传输成功概率）= P（该站点在t0开始传输）（这里是时间点的概率，但是假设的是时间段内的概率，不够数学严谨）* P（其他站点在［t0-1,t0］ 未发生传输）* P（其他站点在［t0，t0+1］ 未发生传输）

= $p\cdot(1-p)^{2(N-1)}$ 

信道传输成功概率 = $Np(1-p)^{2(N-1)}$

选取最优的p 并使得 N一inf

信道传输成功概率 = 1/2e

### 分隙ALOHA

假设所有帧大小一样，将时间划分为等长的时间槽，每个时间槽刚好可以传输1个帧

站点只能在时间槽开始时发起传输
•冲突只在时间槽起点发生

所有站点的时钟是同步的

操作
•当站点有帧需要发送时，在下一个时间槽开始时进行传输
•如果直到传输完毕都没有冲突，则完成
•如果发生冲突，以概率p在下一时间槽重传

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 02.22.18@2x.png" alt="CleanShot 2024-01-03 at 02.22.18@2x" style="zoom:50%;" />

#### 分隙ALOHA的效率

效率的指标：N个站点时，信道传输成功的概率

假设：
• 传输时间为1单位时间
• N个站点，每个站点在单位时间内的传输概率为p，也就是任意一个起始点，某个站点开始传输的概率是p

P（某个站点传输成功概率）= P（该站点在t0开始传输）（这里是时间点的概率，但是假设的是时间段内的概率，不够数学严谨）* P（其他站点在 t0 未发生传输）

= $p\cdot(1-p)^{(N-1)}$ 

信道传输成功概率 = $Np(1-p)^{(N-1)}$

选取最优的p 并使得 N一inf

信道传输成功概率 = 1/e

### 载波侦听多路访问协议

CSMA: Carrier Sense Multiple Access

特点：“先听后发”
• 如果信道空闲，则发送
• 如果信道忙，则推迟发送

类比：会议上有人说话时，不要打断

听完之后，决定如何发送有不同策略：非持续式、1-持续式、P-持续式

### 非持续式CSMA

特点
•①经侦听，如果介质空闲，开始发送
•②如果介质忙，则等待一个随机分布的时间，然后重复步骤①

好处：等待一个随机时间可以減少再次碰撞冲突的可能性

缺点：等待时间内介质上如果没有数据传送，这段时间是浪费的

### 1-持续式CSMA

步骤
•①经侦听，如介质空闲，那么立刻发送
•②如介质忙，持续侦听，一旦空闲重复①

好处：持续式的延迟时间要少于非持续式

问题：如果两个以上的站等待发送，一旦介质空闲就一定会发生冲突
•原因：只要空闲就发送，这种方式又被称作1-持续式

### p-持续式CSMA

步骤
•①经侦听，如介质空闲，那么以**<u>p的概率立刻发送</u>**，以（1-p）的概率推迟一个时间单元再进行处理
•②如介质忙，持续侦听，一旦空闲重复①
•③如果发送已推迟一个时间单元，再重复步骤①

注意
• 1-持续式是p-持续式的特例

CSMA：如侦听到介质上无数据发送才发送，发送后还会发生冲突吗？肯定会！
两种情形
• （1）刚好同时传送；（2）来自其他站点的传播延迟时间

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 02.52.41@2x.png" alt="CleanShot 2024-01-03 at 02.52.41@2x" style="zoom:30%;" />

### 冲突检测 （Collision Detection）

动机：冲突仍然可能发生，一旦冲突发生，造成浪费信道

原理：“先听后发、边发边听”
•发送时持续侦听信道
•一旦传输过程中监听到冲突，立刻中止传输，减少信道浪费

类比
•有礼貌的绅士：说话过程中如果听到其他人也在说话，就马上停下

### CSMA/CD =1-持续式+冲突检测

流程
•①经侦听，如介质空闲，则发送
•②如介质忙，持续侦听，一旦空闲立即发送
•③发送过程中，进行冲突检测
•④如果发生冲突，立即中止发送，然后发送Jam（强化）信号
•⑤等待一个随机分布的时间再重复步骤①

注意
•非持续式、1-持续式、p-持续式关注的是发送前的操作
• 冲突检测关注的是发送后的操作
•因此，非持续式、1-持续式与p-持续式都可以选择与冲突检测进行结合
•实际的CSMA/CD，特指1-持续式＋冲突检测，理论上也可以有p持续+冲突检测，但是没用，会造成信道的浪费

中止传输等一段随机时间不是直接不发了，而是用JAM告诉别人，**<u>防止除了这两个人之外的别人发了</u>**

#### 以太网中的CSMA/CD：二进制回退（Binary exponential backoff）

发生冲突，中止之后：基于**<u>二进制回退</u>**决定随机等待时间
•第n次发生碰撞，从｛0，1,2，⋯，2^n-1｝随机选择一个数K，等待512*K比特数据所需的发送时间

在截断二进制指数后退算法中，如果发生冲突，站点会在一个随机的时间窗口内选择一个随机数来等待。这个时间窗口的范围是从0到\(2^n - 1\)，其中\(n\)是发生的冲突次数，但这个数值有一个最大限制。

通常在以太网的CSMA/CD协议中，这个最大限制被设定为10，意味着即使冲突次数超过10次，时间窗口的大小仍然是在\(2^{10} - 1 = 1024 - 1 = 1023\)范围内。因此，即使发生了12次冲突，由于使用了截断算法，所选的随机数仍然是在0到1023之间。

#### 以太网中的CSMA/CD：如何边发边听？

冲突检测模块比较来自Tx的信号与来自Rx信号，不同则有冲突

在有线信道中容易实现，无线信道较难（无线信道尽量一开始就避免冲突，即CSMA/CA）

#### 传播延迟对载波侦听的影响

信号传输速度：0.65C
to时刻：甲侦听后发送，到达乙约需5微秒
t时刻：乙侦听后发送
t时刻：冲突
tg时刻：乙检测到冲突（需要时间t3-t1）
t时刻：甲检测到冲突（需要时间t4-t0）
所以，自然要求帧发出后侦听的时间不能太短

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 03.37.23@2x.png" alt="CleanShot 2024-01-03 at 03.37.23@2x" style="zoom:30%;" />

#### 冲突窗口

从发出帧到检测发现冲突所需要的最长时间：一个RTT
• 意味着发出后需要侦听一个冲突窗口才能确保没有冲突

数值上：等于最远两站传播时间的两倍，即2D（D是单边延迟）
•2D相当于1个来回传播延迟RTT:Round Trip Time

## ★多路访问控制：轮流协议

### 轮询协议（polling protocol）：外部指定谁发

在站点间选择一个主节点

主节点给其他站点分配信道使用权
•通常轮流通知每个站点，可以传输多少帧
•传输完成后，通知下一个站点

问题：
• 轮询本身占用带宽
•通知引入延迟
•单点故障

不是去中心化的，扩展性不好

### 令牌传递：挨个发

令牌：发送权限
• 只有获得令牌的站点可以发送数据
• 令牌通过特殊的令牌消息进行传递

将站点组织成一定结构，使得可以安排顺序
• 令牌环：环形拓扑
• 除了环，也可以运行在其它拓扑上，如令牌总线

令牌的运行：
• 一个站点获取到令牌后，就可以发送帧，然后把令牌交给下一个站点
• 如果没有帧要发，直接传递令牌

缺点：
• 令牌的维护代价
• 令牌本身的可靠性

### 位图协议（预留协议）：举手示意资源预留

竞争期：在自己的时槽内发送竞争比特
•举手示意资源预留

传输期：按序发送
• 明确的使用权，避免了冲突

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 03.40.47@2x.png" alt="CleanShot 2024-01-03 at 03.40.47@2x" style="zoom:30%;" />

#### 位图协议的利用率

假设
•有N个站点，需N个时隙，每帧d比特

信道利用率
•k个站点需要实际发送数据，利用率为kd / （kd + N）
•在低负荷条件下（K << N）：d/（d+N），N越大，站点越多，利用率越低
•在高负荷条件下（k~N）：d/（d+1），接近100%

缺点
• 位图协议无法考虑优先级

### 二进制倒计数协议

站点：编序号，序号长度相同
竞争期：有数据发送的站点从高序号到低序号排队，高者得到发送权
• 每个站点发送序号中的某1位比特
• 如果发现有更高优先级的站点也要发送（自身比特0，其他站点比特1），则放弃
•最后决出优胜站点，进行发送

#### 例子：站0010、0100、1001和1010都试图要获得信道

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 03.58.44@2x.png" alt="CleanShot 2024-01-03 at 03.58.44@2x" style="zoom:30%;" />

#### 二进制倒计数协议的信道效率分析

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 03.59.04@2x.png" alt="CleanShot 2024-01-03 at 03.59.04@2x" style="zoom:30%;" />

## ★局域网内数据传输

> 链路层交换、逆向学习、MAC地址表转发

相当于一跳就能到达，因为只用mac地址经过switch（别名网桥bridge）或者hub（集线器）就能到达同一个子网内部别的主机

### 链路层交换

理想的交换机是透明的
• 即插即用，无需任何配置
• 网络中的站点无需感知交换机的存在与否

### 逆向学习

MAC地址表的构建-逆向学习源地址

记录帧到达时间
设定老化时间（默认300s）
当老化时间到期时，该表项会被清除。

### MAC地址表转发

A又发，如果交换机发现MAC_A已在表中！
更新该表项的帧达到时间，重置老化时间

小结：MAC地址表的构建
•增加表项：帧的源地址对应的项不在表中
•删除表项：老化时间到期
•更新表项：帧的**<u>源地址在表中</u>**，更新时间戳

MAC地址表会满而溢出吗？
不同的交换机的MAC地址表的大小不同，越是高端的交换机的表空间越大
直连主机的接入交换机（access switch） ，表空间基本在8K左右，1000个MAC地址左右

### 数据链路层交换原理：处理数据帧

#### Forwarding（转发）

找到匹配项！从对应端口2转发出去

#### Filtering（过滤）

找到匹配项！入境口=出境口，丢弃！

#### Flooding（泛洪）

找不到匹配表项！从所有端口（除了入境口）发送出去

一个网段的数据被发送到无关网段，存在安全隐患，浪费网络资源

这也是存在网络层的路由算法的用处，不会频繁地转发。

这里可以逆向学习是因为局域网设备少



两种目的地址的帧，需要泛洪：
•广播帧：目的地址为FF-FF-FF-FF-FF-FF的数据帧
•未知单播帧：目的地址不在MAC地址转发表中的单播数据帧

### 链路层交换机：交换模式

#### 交换模式1：存储转发
•特点：转发前必须接收整个帧、执行CRC校验
•缺点：延迟大
•优点：不转发出错帧

存储转发模式，高延迟，过滤所有错误帧

#### 交换模式2：直通交换
• 特点：一旦接收到帧的目的地址，就开始转发
•缺点：可能转发错误帧
•优点：延迟非常小，可以边入边出

直通模式，低延迟、无错误检查

#### 交换模式3：无碎片交换
•特点：接收到帧的前64字节，即开始转发
•缺点：仍可能转发错误帧
•优点：过滤了冲突碎片，延迟和转发错帧介于存储转发和直通交换之间

过滤了冲突导致的碎片帧，但是无法处理01翻转，当前最常用的模式

### 链路层交换机：使用方式

####  传统LAN分段
•交换机端口通常与集线器连接；
•使用交换机把LAN分段为更小的冲突域。

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 04.51.35@2x.png" alt="CleanShot 2024-01-03 at 04.51.35@2x" style="zoom:30%;" />

#### 现代LAN分段
直连PC，微分段，创建无冲突域，现在就不需要使用CSMA/CD处理冲突的技术了，因为都是全双工了

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 04.51.52@2x.png" alt="CleanShot 2024-01-03 at 04.51.52@2x" style="zoom:30%;" />

## ★局域网间数据传输

> 联系网络层内容

A传输数据到B需要知道的信息：
B的IP地址
A的最近路由器R的IP地址：R为A的网关，A通过静态配置或者DHCP得到R的IP
R的MAC地址（通过ARP得到）

### A创建网络层数据报、链路层帧

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 04.17.00@2x.png" alt="CleanShot 2024-01-03 at 04.17.00@2x" style="zoom:30%;" />

### 帧从A发往R，R收到帧，去除链路层帧头，交给网络层

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 04.17.23@2x.png" alt="CleanShot 2024-01-03 at 04.17.23@2x" style="zoom:30%;" />

### R 根据目的IP B 查询转发表，决定下一跳；R 封装链路层帧，目的MAC地址为B的MAC地址
<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 04.17.46@2x.png" alt="CleanShot 2024-01-03 at 04.17.46@2x" style="zoom:30%;" />

### R将数据发往B

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 04.18.03@2x.png" alt="CleanShot 2024-01-03 at 04.18.03@2x" style="zoom:30%;" />

### B提取IP报文

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 04.18.35@2x.png" alt="CleanShot 2024-01-03 at 04.18.35@2x" style="zoom:30%;" />

### 关于路由器R
有2个接口，每个接口都有自己的IP地址与MAC地址
•属于不同的子网

**<u>2个接口的ARP功能独立</u>**
• ARP表分别记录2个不同子网的“IP->MAC”映射

## IEEE 802.3 以太网

> 帧格式不显式考，以太网发展历史不考

### 以太网帧

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 04.20.30@2x.png" alt="CleanShot 2024-01-03 at 04.20.30@2x" style="zoom:50%;" />

Preamble（前同步码）：8个字节
•前7个字节值均为10101010：用于同步发送方与接收方的时钟频率
•以太网有多种频率：10Mbps、100Mbps、1Gbps、 10Gbps
• 频率可能会发生偏移
• 第8个字节值为10101011：真正的定界符（**<u>字节填充</u>**的定界符）
**<u>物理层交付链路层时</u>**，8字节的前同步码不需要保留，也不计入帧头长度；链路层交付给物理层的时候是要加上这8个字节的

目的地址、源地址：各6字节
•当目的地址与自身地址相同，或者目的地址为一个广播地址，才将帧的data交付给网络层
•否则，丢弃帧 因为是链路层，只允许一跳
•特殊情况：网卡开启混杂模式，可以接收目的MAC地址不是本网络接口的帧
•用途：Hacker、网络分析

类型：2字节，上层（网络层）的报文类型
• 大部分情况下为0x0800，表示网络层为IP协议
• 也可以有其他取值

CRC：接收方用于校验
• 使用CRC32计算除了校验和以外的其他字段

对于检查出的无效MAC帧就简单地丢弃。以太网**<u>不负责重传</u>**丢弃的帧。

#### 长度限制

<u>**payload<=1500**</u>

<u>**64<=帧长**</u>

<u>**所以帧长<=1518，46<=payload**</u>

数据字段不足46字节，需要填充整数字节（Padding在payload）至46字节，以保证以太网MAC帧不小于64

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 04.28.55@2x.png" alt="CleanShot 2024-01-03 at 04.28.55@2x" style="zoom:30%;" />

以太网规定最短有效帧长为64字节，凡长度小于 64 字节的帧都是由于冲突而异常中止的无效帧。
•如果发生冲突，就一定是在发送的前64字节之内
•由于一检测到冲突就立即中止发送，这时已经发送出去的数据一定小于64 字节
• So, why 64B?

802.3规范中的10Mbps以太网，最大长度为2500米，具有4个中继器，在最差情况下往返一次时间大约是50微秒，在这个时间内能发送500bit，加上安全余量增加至512bit，即64Bytes。
RTT=50微秒

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 04.30.17@2x.png" alt="CleanShot 2024-01-03 at 04.30.17@2x" style="zoom:30%;" />

#### 以太网提供的服务
无连接：两个NICs之间无需建立连接即可通信

**<u>不可靠：接收方不发送ACK或者NACK</u>** （但是CSMA/CA有ACK）
• 接收方CRC校验失败或者目的地址不符合都直接丢弃数据，并且不通知发送方
• 依赖上层协议（如TCP）进行丢失数据恢复

多路访问控制：CSMA/CD
• 回退时，基于二进制回退决定随机等待时间

## 虚拟局域网

交换机上连接多组用户

问题1：为每一组用户建立各自局域网，但不添置新交换机

问题2：为每一组用户建立各自**<u>广播域</u>**
• ARP，DHCP，未知MAC地址都会产生广播
• 安全/隐私要求
• 性能要求

### 虚拟局域网的类型
可以通过配置交换机，在一套物理交换机设备上，运行多个虚拟局域网（VLAN）
•每个虚拟局域网，有一个**<u>单独的广播域</u>**

虚拟局域网的类型
•基于端口的VLAN（最常见）
•基于MAC地址的VLAN
• 基于协议的VLAN
• 基于子网的VLAN

### 虚拟局域网-类型1：基于端口

将端口分为不同组

每一组如同一个独立的交换机，即一个VLAN

好处1-流量隔离：发往/来自端口1-8的帧，最终只能到达端口1-8

好处2-动态配置：可以动态变更端口属于哪个VLAN

VLAN之间的数据传输：通过网络层路由（如同2个独立局域网之间）
•现代路由器/交换机同时支持链路层与网络层传输，所以新加入不用路由器了

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 04.56.03@2x.png" alt="CleanShot 2024-01-03 at 04.56.03@2x" style="zoom:30%;" />

### 虚拟局域网 -类型2：基于MAC地址

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 04.55.48@2x.png" alt="CleanShot 2024-01-03 at 04.55.48@2x" style="zoom:30%;" />

MAC地址决定了成员身份

### 虚拟局域网-类型3：基于协议

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 04.56.38@2x.png" alt="CleanShot 2024-01-03 at 04.56.38@2x" style="zoom:30%;" />

通常需要主机的参与

### 虚拟局域网-类型4：基于子网

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 04.57.19@2x.png" alt="CleanShot 2024-01-03 at 04.57.19@2x" style="zoom:30%;" />

一个子网就是一个VLAN

## 生成树协议、PPP、PPPOE均不考

> 都不考！

## ★无线网络

> 不考：蓝牙、LTE QoS

### 无线网络的分类

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 04.59.25@2x.png" alt="CleanShot 2024-01-03 at 04.59.25@2x" style="zoom:30%;" />

### 无线链路特征

递减的信号强度
•信号穿过物体时，强度将减弱
• 即使自由空间中，随着距离增加也会衰減（称为路径损耗 path loss）

其他信号源的干扰
•如：2.4GHz 无线LAN与2.4GHz 无线电话
•微波、电动机等等

多路径传播：电磁波反射后，通过不同路径到达接收端

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 05.01.52@2x.png" alt="CleanShot 2024-01-03 at 05.01.52@2x" style="zoom:50%;" />

信噪比 （Signal-to-noise ratio,SNR）：收到信息强度与噪声强度的相对值
•单位：分贝
•信噪比越高，越容易提取信息
比特差错率（BER）：接收方收到的错误比特的比例

物理层：不同传输速率、不同BER vs SNR
• 给定物理层：**<u>增加传输功率->增加SNR</u>**->降低BER
• 给定信噪比：增加传输速率-> 增加BER

信噪比和功率是正相关的

### 无线链路中的多路访问问题

问题1：隐藏终端
• B与A可以互相听到
• B与C可以互相听到
• A与C之间存在障碍，无法听到对方存在

问题2：信号衰减
• B与A可以互相听到
• B与C可以互相听到
• A与C之间收到的对方信号极为微弱

更无法知道双方在B处互相干扰，也就是可能根本不知道有竞争

### 码分复用 Code Division Multiple Access （CDMA）

本质上将所有可能编码的集合划分给用户
• 所有用户采用同样的信道频段
• 每个用户拥有各自的编码机制（称为码片 code chipping）

允许用户同时传输数据
•通过编码机制的设计，尽量减少干扰的影响（称为编码正交性）

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 05.05.12@2x.png" alt="CleanShot 2024-01-03 at 05.05.12@2x" style="zoom:50%;" />

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 05.06.11@2x.png" alt="CleanShot 2024-01-03 at 05.06.11@2x" style="zoom:50%;" />

### IEEE 802.11无线局域网（又称WiFi）

所有都使用 CSMA/CA 进行多路访问控制
所有都支持基础设施模式与自组网模式

802.11a
5 GHz频段
• 最高速率 54 Mbps，wifi**<u>专用，所以更快</u>**

#### 无线局域网架构

网络由基本服务集（Basic Service Set，BSS） 组成
基本服务集包含：	
•无线主机
•接入点（access point, AP）：基站的角色
•	主机间通过AP进行通信
•	只在基础设施模式下存在
•自组织模式：只有无线主机

#### 信道与关联

每个无线主机在能够发送或接收网络层数据之前，必须与一个AP关联（association）



首先要部署AP

AP的部署（802.11b为例）
• 管理员为每个AP配置一个服务集标识符（SSID）
• 802.11b频段范围 2.4GHz-2.485GHz spectrum，被划分为11个信道
• 管理员为AP选择一个信道
• 冲突不可避免：不同的AP可能选择相同信道、信道可能重叠



然后主机连接AP：

主机**<u>被动扫描</u>**关联AP的过程
• **<u>AP周期性发送信标帧</u>**（beacon frame），包含AP的SSID与MAC地址
• 主机扫描信道，监听信标帧
• 收到多个AP的信标帧时，选择1个进行关联
• 没有明确的选择算法
• 关联时，需要身份验证（可选）、分配IP（通常用DHCP）

被动扫描：
（1） AP发送信标帧
（2） H1向选择的AP发送关联请求帧
（3） 被选择的AP向H1回复关联响应帧

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 13.48.53@2x.png" alt="CleanShot 2024-01-03 at 13.48.53@2x" style="zoom:30%;" />

**<u>主动扫描</u>**：
（1） H1广播探测请求帧
（2） AP返回探测响应帧
（3） H1向选择的AP发送关联请求帧
（4） 被选择的AP向H1回复关联响应帧

#### 多路访问控制

目标：避免冲突，即防止多于1个站点同时在信道内传输数据

发送前侦听信道
• 避免干扰正在使用信道的其他站点

发送时不再进行冲突检测（有别于以太网CSMA/CD），因为检测也没用
•由于信号强度衰减，发送时很难收到冲突信号
• 无法解决所有场景：隐藏终端，信号衰減
• CSMA/CA （colision avoidance）：**<u>发送前就尽量避免冲突</u>**

#### CSMA/CA

802.11 发送方

1. 如果发送前信道空闲时间达到DIFS，则发送整个帧
   发送时不进行冲突检测
2. 如果发送前检测到信道忙，则选择一个随机值作为计时器 DIFS 1
   信道空闲时，计时器递减
   信道忙时，计时器不变
3. 计时器减为0时，发送，并等待ACK
4. 收到ACK后，若马上有下一帧发送，进入步骤2；若未收到ACK，进入步骤2准备重传，并且使用更大的随机值

802.11接收方
如果收到1个正确的帧，等到SIFS时间后，发送ACK（由于隐藏终端，ACK是必要的）必须要有ack才能确定没有receiver没有被干扰，因为存在隐藏终端，sender不确认信道有没有被干扰

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 13.52.51@2x.png" alt="CleanShot 2024-01-03 at 13.52.51@2x" style="zoom:30%;" />

#### CSMA/CA：采用倒计时的原因

**<u>避免冲突的机制1</u>**

CSMA/CD：一旦空闲，立刻发送
CSMA/CA：一旦空闲，递减计时器

防止某个帧传输结束时，多个发送者马上发送冲突，因为对于csmacd可以通过侦听来解决冲突，但是由于无线传输的限制，Csma/ca产生冲突不好解决

#### 802.11：预约机制

**<u>避免冲突的机制2</u>**，因为即使随机倒计时也很大可能冲突

核心思想：允许发送者“预约保留"信道，而不是随机访问，避免大帧传输的冲突



DIFS（分布式协调功能间隔，Distributed Inter-Frame Space）和SIFS（短间隔帧间隔，Short Inter-Frame Space）

1. **SIFS（短间隔帧间隔）**：
   - SIFS 是无线网络中最短的时间间隔。
   - 它用于优先传输特定类型的帧，如确认帧（ACK）和某些管理帧。
   - SIFS 的目的是确保在数据帧和它的确认帧之间有足够的快速响应，这样就可以有效地维持通信。

2. **DIFS（分布式协调功能间隔）**：
   - DIFS 比 SIFS 长，是用于数据帧之间的标准间隔。
   - 当一个设备想要发送数据时，它会先监听空中是否有其他传输。如果它检测到空气中有一段时间内没有信号（即DIFS时间），则开始传输数据。
   - DIFS 有助于减少数据包之间的碰撞，因为它提供了一个时间缓冲，让其他设备有机会发送它们的数据。

简而言之，SIFS 和 DIFS 是无线网络中用于确保数据传输顺序和减少碰撞的两种不同时间间隔。SIFS 用于更高优先级的传输，如确认帧，而 DIFS 用于常规数据帧的传输。



预约过程：

1. 步骤1：发送者先使用CSMA/CA发送一个小报文RTS（request-to-send） 给基站
   • RTS报文仍然可能发生冲突
   • 发生冲突时重试
   • 代价可以接受：RTS很小
2. 步骤2：基站广播CTS（clear-to-send）消息，作为对RTS的回复
3. 步骤3：所有站点都会收到CTS
   • 发送者开始传输
   • 其他站点推迟传输 
4. 步骤4：其他站点在传输完成后也能收到ACK 
   • 开始传输

完全避免数据传输时信道冲突问题，只在RTS预约时冲突，而RTS预约冲突重传开销不大



预约之后多长时间再发数据帧：

发送 CTS（Clear To Send）帧后，节点在发送第一个数据帧之前通常会等待一个 SIFS（短间隔帧间隔）的时间。这是因为 SIFS 是无线网络中用于特定控制帧和响应帧的最短时间间隔，其目的是确保网络中的高优先级消息可以迅速传输。

流程通常如下：

1. **RTS/CTS 机制**：在某些无线网络协议中，如 IEEE 802.11，节点在发送数据前先发送一个 RTS（Request To Send）帧以请求发送权限。
   
2. **接收到 CTS**：周围节点接收到 RTS 后停止发送数据，等待一段时间。然后，目标节点发送 CTS 帧回应，表示它已经准备好接收数据。

3. **发送数据帧**：发送 RTS 的节点在接收到 CTS 帧后，会等待一个 SIFS 时间间隔，然后开始发送数据帧。

所以，**<u>发送 CTS 帧后等待的时间通常就是 SIFS 的长度</u>**。SIFS 的具体时间长度取决于所使用的无线标准和物理媒介，但通常它是非常短的，以确保快速响应。例如，在 IEEE 802.11b 标准中，SIFS 约为 10 微秒，DIFS约为 50 微秒。



例子：其中只有RTS需要DIFS时间才能发，别的都是SIFS

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 14.05.30@2x.png" alt="CleanShot 2024-01-03 at 14.05.30@2x" style="zoom:30%;" />

#### 802.11：地址字段

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 14.11.59@2x.png" alt="CleanShot 2024-01-03 at 14.11.59@2x" style="zoom:30%;" />

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 14.10.15@2x.png" alt="CleanShot 2024-01-03 at 14.10.15@2x" style="zoom:30%;" />

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 14.10.27@2x.png" alt="CleanShot 2024-01-03 at 14.10.27@2x" style="zoom:30%;" />

注意AP传输给路由器的时候MAC源地址是最开始的主机，而不是自己的AP地址

#### 同一子网下的移动

H1从基本服务集BBS 1移动到基本服务集BBS 2
BBS 1与BBS 2属于同一子网，其AP连到同一交换机不同端口

移动后，H1仍在同一子网内，IP地址不变
交换机：通过逆向学习，知道H1连向哪个端口

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 14.14.56@2x.png" alt="CleanShot 2024-01-03 at 14.14.56@2x" style="zoom:30%;" />

从教学楼回宿舍，校园网突然卡一下，就是因为AP设备不同了，转发表还没更新，所以临时没网了

#### 802.11其他功能：自适应传输速率

•根据无线主机的移动，信噪比SNR发生变化（与功率有关）
•基站与无线主机都将动态调整传输速率
•通过改变物理层的调制技术

总目标是控制BER

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 14.16.06@2x.png" alt="CleanShot 2024-01-03 at 14.16.06@2x" style="zoom:30%;" />

1. 主机远离基站-> 功率降低->SNR 降低->BER上升
2. 想要控制BER不要太大
3. 当BER超过一定阈值->选择有更低传输速率但BER也更低的物理层方案



#### 802.11其他功能：功率管理

无线主机在睡眠/唤醒两种状态间切换，睡眠状态下节省能耗
问题：睡眠状态下，AP无法向主机发送帧

流程：
•主机->AP：通知将进入睡眠状态，直到下一个信标帧到来
•	在802.11帧首部将功率管理比特置1
•	信标帧每隔100ms发送一次
•AP：在下一个信标帧之前，不再给该主机发送帧，而是进行缓存
•	信标帧：列出了有帧缓存的无线主机
•如果有帧缓存：接收信标帧后主机进入唤醒状态，接收帧
•如果没有帧缓存：接收一个信标帧，继续睡眠
•唤醒时间：250us，没有缓存帧，也要唤醒主机250us，因为得接收信标帧



### 蜂窝网

核心思想：通过移动电话网络，提供移动数据传输

小区（cell）：覆盖某个地理区域
基站（base station, BS）：类似 802.11 AP，移动用户通过基站连接到网络

移动交换中心MSC：将小区连接到有线网络，管理呼叫建立，处理移动性

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 14.24.29@2x.png" alt="CleanShot 2024-01-03 at 14.24.29@2x" style="zoom:30%;" />

#### 蜂窝网的第一跳
这是2345G的区别主要的地方

空中接口 （air interface）：将无线设备连接到基站

2G：组合使用FDMA与TDMA
•将信道划分內频段
•每个频段划分为时间片

3G: CDMA
• W-CDMA（欧洲）
•CDMA-2000（美国）
• TD-SCDMA（中国）

4G：正交频分复用

5G：非正交频分复用 +MIMO

#### 2G网络架构

1. 完全使用语音网络

2G又称GSM

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 14.25.38@2x.png" alt="CleanShot 2024-01-03 at 14.25.38@2x" style="zoom:30%;" />

#### 3G网络架构：

1. 语音＋数据网络
2. 单独的数据网络

核心特点：
• 语音网络核心架构不变
• **<u>单独的数据网络</u>**并行运作

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 14.27.06@2x.png" alt="CleanShot 2024-01-03 at 14.27.06@2x" style="zoom:30%;" />

Serving GPRS Support Node (SGSN)
Gateway GPRS Support Node (GGSN)

#### 4G LTE网络架构

1. 没有语音网络
2. 控制平面与数据平面分离

统一的全IP架构：语音、数据都封装在IP报文中，在基站-网关间传输，**<u>不再有语音网络</u>**

**<u>控制平面与数据平面分离</u>**

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 14.30.33@2x.png" alt="CleanShot 2024-01-03 at 14.30.33@2x" style="zoom:30%;" />

HSS（不在图中）：存储用户相关信息
MME： 管理用户状态

用户状态的简化模型：

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 14.38.57@2x.png" alt="CleanShot 2024-01-03 at 14.38.57@2x" style="zoom:30%;" />

IDLE状态：没有数据发送，有大量数据来就变成DCH

DCH：终端拥有单独信道，高速传输（能耗大）

FACH：终端与其他终端共享信道，低速传输（能耗小）

### 管理移动性的一般方法

#### 移动性概念

无移动性：用户在相同的无线接入网中接入

中移动性：用户在接入网之间移动，但移动时断开连接

高移动性：用户在接入网间移动，同时保持连接



归属网络：每个移动设备有个长期的归属网络，一般不更换（如：128.119.40/24）

归属代理：归属网络中，代表移动设备执行移动性功能的实体

永久地址：移动设备在归属网络中的地址，可以总是访问到该移动设备（如：128.119.40.186）



被访网络（或外部网络）：移动设备当前所在的网络（e.g. 79.129.13/24）

外部代理：外部网络中，代表移动设备执行移动性功能的实体

转交地址care-of-address （COA）：移动设备在被访网络内的地址(e.g., 79,129.13.2)

通信者：希望与移动设备通信的实体

#### 设备注册

移动设备进入访问网络时，连接外部代理，申请转交地址

外部代理通知归属代理：（有时候，也可以由设备自身通知归属代理）
1. 该设备属于自己的访问网络
2. 该设备的转交地址

结果：
• 外部代理知道该设备的存在
• 归属代理知道该设备的位置

#### 注册之后移动设备如何通信

通过路由解决：网络中路由器为移动设备的永久地址创建路由表项，**<u>发送到这个永久地址的时候就转发到不同的访问网络</u>**
•通过交换路由信息创建（标准网络路由过程）
•路由表说明了该移动设备的位置（属于哪个外部网络）

但是路由方法无法处理大量信息



通过代理解决：

•间接路由：通信者 归属代理 外部代理 移动设备

对于通信者而言，设备移动、访问网络改变、转交地址改变是透明的，所以设备与通信者的**<u>连接仍然可以保持</u>**！

三角路由问题：效率低下，特别当**<u>通信者与移动设备在同一访问网络</u>**时，本来不用绕圈，但是间接路由还是绕圈了

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 15.00.44@2x.png" alt="CleanShot 2024-01-03 at 15.00.44@2x" style="zoom:30%;" />

•直接路由：通信者 外部代理 移动设备，但是仍需要通过归属代理，获取移动设备的转交地址

对通信者不透明：通信者必须从归属代理获取转交地址

解决了三角路由问题

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 15.03.00@2x.png" alt="CleanShot 2024-01-03 at 15.03.00@2x" style="zoom:30%;" />

如果设备移动到其他访问网络？使用锚外部代理保持连接

使用锚外部代理（anchor foreign agent）：第一个访问网络中的外部代理
通信者数据始终发往锚外部代理，由锚外部代理转发到当前访问网络

当设备到达新的访问网络时：
•向新的外部代理注册（步骤3）
• 新的外部代理向锚外部代理提供新的转交地址（步骤4） 第一个访问网络

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 15.05.37@2x.png" alt="CleanShot 2024-01-03 at 15.05.37@2x" style="zoom:30%;" />

### 移动IP、蜂窝网的移动性管理

#### 移动IP下的代理发现

代理通告-外部代理/归属代理通过广播ICMP报告（typefield=9），通告代理服务的存在
代理请求—设备发送代理请求报文 （ICMP typefiled=10），然后代理广播通告

#### 移动IP下的代理注册

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 15.21.05@2x.png" alt="CleanShot 2024-01-03 at 15.21.05@2x" style="zoom:30%;" />

#### 蜂窝网的移动性管理

归属网络：设备订购服务的网络（如：中国移动、中国联通、中国电信）
•归属位置注册器（HLR）：一个数据库，记录了用户当前位置、电话号码以及各类用户信息（订阅服务、账单、使用偏好）
• 归属MSC：即之前提到的网关MSC
•归属MSC+归属HLR=归属代理

被访网络：用户设备当前所处网络
•访问者位置注册（VLR）：一个数据库，记录访问者信息
•VLR+被访网络的MSC=外部代理
•被访网络有时与归属网络是同一网络

#### GSM间接路由

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 15.22.35@2x.png" alt="CleanShot 2024-01-03 at 15.22.35@2x" style="zoom:30%;" />

#### GSM切换：同一MSC，不同基站

切换：将呼叫路径从一个基站转移到另一个基站

原因：GSM没有规定切换策略（即何时切换），只规定切换机制（即如何切换）
• 新基站信号更强
• 负载均衡：释放旧基站的信道（GSM采用组合FDM/TDM）

**<u>切换由旧基站发起，而不是像直接路由的锚外部代理那样，主机连接到新基站再由新基站发起切换</u>**

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 15.23.59@2x.png" alt="CleanShot 2024-01-03 at 15.23.59@2x" style="zoom:30%;" />

1. 旧基站通知被访MSC即将发起切换，并提供包含至少1个新基站的列表

2. MSC选择新基站，设置到新基站的路径，分配相应路由资源，通知新基站
3. 新基站分配无线信道给该设备
4. 新基站通知MSC与旧基站，并提供与设备的关联信息
5. 旧基站告诉无线设备，即将进行切换
6. 移动设备与新基站交换信息，激活信道
7. 移动用户通知新基站与MSC，完成激活。
8. MSC通知基站释放资源

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 15.26.05@2x.png" alt="CleanShot 2024-01-03 at 15.26.05@2x" style="zoom:30%;" />

#### GSM切换：MSC之间

锚MSC：第一个被访网络中的MSC，后续呼叫都经过锚MSC

设备向新MSC注册时，新MSC通知锚MSC设备位置信息

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 15.31.34@2x.png" alt="CleanShot 2024-01-03 at 15.31.34@2x" style="zoom:30%;" />

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 15.31.45@2x.png" alt="CleanShot 2024-01-03 at 15.31.45@2x" style="zoom:30%;" />

### LTE （4G）中的移动性管理

GSM：电话网络中，设备始终处于激活状态

4G：设备可能处于休眠状态

休眠状态下，从一个基站移动到另一个基站，网络无法获知位置移动
解决方案：寻呼（paging），基站定期广播报文，确认设备仍然存在

切换过程：与2G、3G类似
•新基站与MSC准备
•执行切换
•完成切换

<img src="./5.数据链路层.assets/CleanShot 2024-01-03 at 15.32.55@2x.png" alt="CleanShot 2024-01-03 at 15.32.55@2x" style="zoom:50%;" />
